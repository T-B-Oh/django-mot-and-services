{% extends 'booking/base.html' %}
{% block content %}
{% load static %}

<link rel="stylesheet" href="{% static 'css/checkout.css' %}">
<script src="{% static 'js/checkout.js' %}" defer></script>
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/popper.js@1.14.7/dist/umd/popper.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

<div class="checkout-title-group">
    <div class="title">
        <div class="header-1"> Booking Information </div>
        <div class="header-2"> Please fill up the blank fields below </div>
    </div>
</div>

<div class="checkout">
    <div class="checkout-group">
        <div class="checkout-sub-box package-vehicle-group">
            <!-- package info section -->
            <div class="package-box">
                {% for p in current_package %}
                    {% if p.package_type == 'MOT' %}
                        <div class="package-icon"> 
                            <img class="container" src="{% static 'image/mot-icon.png' %}" alt="MOT Icon"/>
                        </div>
                    {%elif p.package_type == 'Offers' %}
                        <div class="package-icon2"> 
                            <img class="container" src="{% static 'image/service-mot-icon.png' %}" alt="MOT Icon"/>
                        </div>
                    {%else%}
                        <div class="package-icon"> 
                            <img class="container" src="{% static 'image/service-icon.png' %}" alt="MOT Icon"/>
                        </div>
                    {% endif %}
                {% endfor %}
                <div class="package-info-box">
                    <div class="package-header"> Your Package: </div>
                    <div class="package-input"> 
                        {% for p in current_package %}
                            {{ p.package_name }}
                        {% endfor %}
                    </div>
                </div>
                <div> 
                    <a class="package-change-button" id="changePackageButton" name="change">Change?</a>    
                </div>
            </div>
            <!-- Pop up Change Package -->
            <div id="changePackageModal" class="modal" tabindex="-1" role="dialog">
                <div class="modal-dialog" role="document">
                    <div class="modal-content">
                        <div class="popup-header-section">
                            <h5 class="popup-header">Select New Package</h5>
                        </div>
                        <div class="popup-selection">
                            <label for="package">Packages:</label>
                            <select id="packageType" name="package">
                                <option value="">Select Package</option> 
                                {% for ap in all_packages %}
                                    <option value="{{ap.package_name}}" package-code="{{ ap.id }}"> {{ ap.package_name }}</option>
                                {% endfor %}
                            </select>
                        </div>
                        <div class="btns">
                            <button type="submit" class="change-btn add-selection" >Change Package Now</button>
                            <button type="button" class="close-btn" data-bs-dismiss="modal">Close</button>
                        </div>
                    </div>
                </div>
            </div> 
            <!-- vehicle info section -->
            <div class="vehicle-box">
                <div class="uk-logo">
                    <div class="uk"> UK </div>
                </div>
                {% if reg %}
                    <div class="v-input-1"> 
                        {{ reg  }}
                    </div>
                    <div class="v-input-2">
                        {{ make  }} - {{ model  }} ({{ year  }})             
                    </div>
                {%else%}
                    <input class="checkout-reg-input" type="text" id="get_vehicle" placeholder="Vehicle Reg"
                            oninput="this.value = this.value.toUpperCase()" pattern="[A-Z0-9]*">
                    <button class="search-button-box" onclick="searchVehicleChange()"> Search </button>
                {%endif%}
            </div>
            {% if reg and show_vehicle_form %}
            <!-- Vehicle Register to current user -->
            <div id="vehicle_form" class="form">
                <form id="vehicle_form" method="post">
                    {% csrf_token %}
                        <input type="hidden" id="owner" name="owner" value="{{ vehicle_form.owner.value|default:request.user }}" readonly>
                        <input type="hidden" id="reg" name="reg" class="input-box" value="{{ reg }}" readonly>
                        <input type="hidden" id="make" name="make" class="input-box" value="{{ make }}" readonly>
                        <input type="hidden" id="model" name="model" class="input-box" value="{{ model }}" readonly>
                        <input type="hidden" id="year" name="year" class="input-box" value="{{ year }}" readonly>
                        <button class="next-button-box" type="submit" name="vehicle_submit"> Next </button>
                </form>  
            </div>
            {%endif%}      
        </div>
        {% if show_profile_form %}
        <div class="checkout-sub-box bookingformbox">
            <div > 
                <a class="change-button-box" id="changeVehicleButton" name="change"> Change Vehicle </a>
            </div>

            <!-- pop up change vehicle -->
            <div id="changeVehicleModal" class="modal" tabindex="-1" role="dialog">
                <div class="modal-dialog" role="document">
                    <div class="modal-content">
                        <div class="popup-header-section">
                            <h5 class="popup-header">Search New Vehicle</h5>
                        </div>
                        <div class="popup-selection">
                            <input class="reg-input" type="text" id="get_vehicle" placeholder="Vehicle Reg" 
                                    oninput="this.value = this.value.toUpperCase()" 
                                    pattern="[A-Z0-9]*" title="Only uppercase letters and numbers allowed">
                            <button class="reg-search-button" onclick="searchVehicleChange()"> Search </button>
                        </div>
                        <div class="btns">
                            <button type="button" class="close-btn" data-bs-dismiss="modal">Close</button>           
                        </div>
                    </div>
                </div>
            </div>

            <!-- partial profile form (firstname, lastname and contact) -->
            <div class="form">
                <form id="partial_profile_form" method="post">
                    {% csrf_token %}
                        <label for="first_name">First Name:</label>
                    {% if profile.first_name %}
                        <input type="text" id="first_name" name="first_name" value="{{ profile.first_name }}" readonly>
                    {% else %}
                        <input type="text" id="first_name" name="first_name" value="">
                    {% endif %}

                    <label for="last_name">Last Name:</label>
                    {% if profile.first_name %}
                        <input type="text" id="last_name" name="last_name" value="{{ profile.last_name }}" readonly>
                    {% else %}
                        <input type="text" id="last_name" name="last_name" value="">
                    {% endif %}

                    <label for="last_name">  Contact Number:   </label>
                    {% if profile.contact %}
                        <input type="text" id="contact" name="contact" value="{{ profile.contact }}" readonly>
                    {% else %}
                        <input type="text" id="contact" name="contact" value="">
                    {% endif %}

                    <button class="next-button-box-2" type="submit" name="profile_submit"> Next </button>
                </form>
                <div id="form-error" style="display: none;" class="error-popup">
                    All fields are required.
                </div>        
            </div>
        </div>
        {% endif %}

        <!-- main booking form -->
        {% if show_second_form %}
        <div class="checkout-sub-box bookingformbox">
            <div class="bookingformboxsub">        
                <div class="form">
                    <form id="booking_form" method="post">
                        {% csrf_token %}
                        <div>
                        <input type="hidden" id="vehicle_id" name="vehicle_id" value="{{ get_id }}" readonly>
                        <input type="hidden" id="owner" name="owner" value="{{ booking_form.owner.value|default:request.user }}" readonly>
                        <input type="hidden" id="package_id" name="package_id" value="{{ selected_package_id.id }}" readonly>
                    
                        <label for="booking_date">Select Date:</label>
                        <input type="date" id="booking_date" name="booking_date" required min="{{ tomorrow_date }}"><br><br>

                        <label for="booking_time">Select Available Time Slot:</label>
                        <select id="booking_time" name="booking_time" required>
                            <option value="">Select a time</option>
                        </select><br><br>
                        </div>
                        <button class="check-out-button2" type="submit" name="booking_submit">Book</button>                     
                    </form>
                </div>
            </div>
        </div>
        {% endif %}
    </div>
            
    <!-- summary Box -->
    <div class="summary-group order-summary-box">
        <div class="header-bar">
            <div class="summary-header"> Summary </div>
        </div>
        <div class="price-row">
            <div class="price"> Price</div>
            <div class="price-value"> £ {{ before_vat }} </div>
        </div>
        <div class="vat-row">
            <div class="vat"> VAT </div>
            <div class="vat-value"> £ {{ vat }} </div>
        </div>
        <div class="line"> </div>
        <div class="total-row">
            <div class="total">Total</div>
            <div class="total-value"> 
                {% for p in current_package %}
                        £ {{ p.price }}
                {% endfor %}
            </div>
        </div>
    </div>
</div>
                
{% endblock %}